name: Deploy @apps/web

on:
  push:
    branches: ['main']
    paths:
      - 'apps/web/**'
      - 'packages/ui/**'
      - 'packages/contracts/**'
      - 'pnpm-lock.yaml'
      - '.github/workflows/deploy-web.yml'

concurrency:
  group: deploy-web
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: SSH Deploy
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            bash -lc '
              set -e

              export NVM_DIR="$HOME/.nvm"
              [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
              nvm use 20

              cd /home/minjae/blog/FE-v4

              git fetch --all
              git reset --hard origin/main

              # env file (heredoc 대신 printf)
              printf "%s\n" \
              "NEXT_PUBLIC_API=${{ secrets.NEXT_PUBLIC_API }}" \
              "NEXT_PUBLIC_GITHUB_REPO=${{ secrets.NEXT_PUBLIC_GITHUB_REPO }}" \
              "NEXT_PUBLIC_BLOG_ID=${{ secrets.NEXT_PUBLIC_BLOG_ID }}" \
              "NODE_ENV=production" \
              > apps/web/.env.production

              pnpm install --frozen-lockfile
              pnpm --filter @apps/web build

              pm2 restart blog-web || pm2 start pnpm --name blog-web -- --filter @apps/web start --hostname 0.0.0.0 --port 3000
              pm2 save
            '
